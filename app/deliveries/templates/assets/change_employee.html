{% extends 'admin/change_list.html' %}
{% block extrastyle %}
{{ block.super }}
<style>
  .change-list .filtered{
    min-height: auto !important;
  }
  
  .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .loading-overlay .loading-spinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
      background-color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .bulk-action-form {
      display: flex;
      flex-direction: row;
      align-items: left;
    }
  
    .bulk-action-form > * {
      margin-right: 1rem;
      margin-bottom: 0.5rem;
    }

    .bulk-action-form h1 {
      margin-right: 1rem;
    }
  
    .bulk-action-form label,
    .bulk-action-form select,
    .bulk-action-form input[type="submit"] {
      margin-right: 1rem;
    }
  
    /* Medium-sized screens (col-6) */
    @media (max-width: 992px) {
      .bulk-action-form {
        flex-direction: column;
        align-items: left;
      }
  
      .bulk-action-form h1 {
        margin: 0;
        margin-bottom: 1rem;
      }
    }
  
    /* Small screens (col-12) */
    @media (max-width: 576px) {
      .bulk-action-form > box {
        flex: 1;
        margin: 1rem;
      }

      .bulk-action-form label,
      .bulk-action-form select,
      .bulk-action-form input[type="submit"] {
        margin-right: 0;
        margin-bottom: 1rem;
      }
    }

</style>
{% endblock %}

{% block filters %}
  {{ block.super }}

  <div style="
    place-items: center;
    border: 1px solid;
    padding: 12px;
    border-radius: 4px;
    white-space: nowrap;
    outline: 0;
    box-sizing: border-box;
    margin-bottom: 10px;
    background-color: #fff;
    color: #003459;
    border: 1px solid #ededed;
    appearance: none;
    transition: background 0.3s, box-shadow 0.3s, border 0.3s;
  ">
    <h1>Bulk Action:</h1>
    <form id="update-deliveries-form" action="/admin/deliveries/update-deliveries/" method="post" class="bulk-action-form">
      {% csrf_token %}
      <label for="id_employee">Employee:</label>
      <select id="id_employee" name="new_employee_id">
        {% for employee_id, employee_name in employee_choices %}
          <option value="{{ employee_id }}">{{ employee_name }}</option>
        {% endfor %}
      </select>
      <label for="id_status">Status:</label>
      <select id="id_status" name="new_status">
        {% for status_key, status_value in status_choices %}
          <option value="{{ status_key }}">{{ status_value }}</option>
        {% endfor %}
      </select>
  
      <input type="hidden" name="url" value="{{ request.path }}">
      <input type="submit" value="Update Deliveries" />
    </form>
  </div>
  <div class="loading-overlay" id="loading-overlay" style="display: none">
    <div class="loading-spinner"></div>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelector('.actions').style.display = 'none';
    // Get all checkboxes with the name '_selected_action'
    const checkboxes = document.querySelectorAll('input[name="_selected_action"]');
    const selectAllCheckbox = document.querySelector('.action-checkbox-column input[type="checkbox"]');
    let selectedDeliveryIds = []; // Array to store selected delivery IDs

    // Function to update selectedDeliveryIds array
    function updateSelectedDeliveryIds() {
      selectedDeliveryIds = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);

      // Log the list of selected delivery IDs
      console.log("Selected Delivery IDs:", selectedDeliveryIds);
    }

    // Attach the change event handler to the "Select All" checkbox
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function () {
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
        updateSelectedDeliveryIds();
      });
    }

    // Attach the change event handler to individual checkboxes
    checkboxes.forEach(function (checkbox) {
      checkbox.addEventListener('change', function () {
        updateSelectedDeliveryIds();
      });
    });

    // Attach the form submission event handler
    const form = document.getElementById('update-deliveries-form');
    if (form) {
      form.addEventListener('submit', function (event) {
        // Prevent the default form submission
        event.preventDefault();

        // Display the loading overlay
        document.getElementById('loading-overlay').style.display = 'flex';

        // Add the distinct selected delivery IDs as hidden inputs before form submission
        const distinctSelectedIds = [...new Set(selectedDeliveryIds)];
        distinctSelectedIds.forEach(function (deliveryId) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'selected_deliveries'; // Use the correct name
          input.value = deliveryId;
          form.appendChild(input);
        });

        // Continue with the form submission
        form.submit();
      });
    }
  });
</script>
{% endblock %}
