{% extends 'admin/change_list.html' %}
{% block extrastyle %}
{{ block.super }}
<style>
.change-list .filtered{
  min-height: auto !important;
}
</style>
{% endblock %}

{% block filters %}
  {{ block.super }}

  <div style="
    place-items: center;
    border: 1px solid;
    padding: 12px;
    border-radius: 4px;
    white-space: nowrap;
    outline: 0;
    box-sizing: border-box;
    margin-bottom: 10px;
    background-color: #fff;
    color: #003459;
    border: 1px solid #ededed;
    appearance: none;
    transition: background 0.3s, box-shadow 0.3s, border 0.3s;
  ">
    <h1>Bulk Action:</h1>
    <div style="display: flex; flex-direction: row">
      <form id="update-deliveries-form" action="/deliveries/update-deliveries/" method="post">
        {% csrf_token %}
        <label for="id_employee">Employee:</label>
        <select id="id_employee" name="new_employee_id">
          {% for employee_id, employee_name in employee_choices %}
            <option value="{{ employee_id }}">{{ employee_name }}</option>
          {% endfor %}
        </select>

        <label for="id_status" style="margin-left: 1rem;">Status:</label>
        <select id="id_status" name="new_status">
          {% for status_key, status_value in status_choices %}
            <option value="{{ status_key }}">{{ status_value }}</option>
          {% endfor %}
        </select>

        <input type="hidden" name="url" value="{{ request.path }}">
        <input type="submit" value="Update Deliveries" style="margin-left: 1rem;"/>
      </form>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelector('.actions').style.display = 'none';
    // Get all checkboxes with the name '_selected_action'
    const checkboxes = document.querySelectorAll('input[name="_selected_action"]');
    const selectAllCheckbox = document.querySelector('.action-checkbox-column input[type="checkbox"]');
    let selectedDeliveryIds = []; // Array to store selected delivery IDs

    // Function to update selectedDeliveryIds array
    function updateSelectedDeliveryIds() {
      selectedDeliveryIds = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value);

      // Log the list of selected delivery IDs
      console.log("Selected Delivery IDs:", selectedDeliveryIds);
    }

    // Attach the change event handler to the "Select All" checkbox
    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', function () {
        checkboxes.forEach(checkbox => {
          checkbox.checked = selectAllCheckbox.checked;
        });
        updateSelectedDeliveryIds();
      });
    }

    // Attach the change event handler to individual checkboxes
    checkboxes.forEach(function (checkbox) {
      checkbox.addEventListener('change', function () {
        updateSelectedDeliveryIds();
      });
    });

    // Attach the form submission event handler
    const form = document.getElementById('update-deliveries-form');
    if (form) {
      form.addEventListener('submit', function (event) {
        // Prevent the default form submission
        event.preventDefault();

        // Add the distinct selected delivery IDs as hidden inputs before form submission
        const distinctSelectedIds = [...new Set(selectedDeliveryIds)];
        distinctSelectedIds.forEach(function (deliveryId) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'selected_deliveries'; // Use the correct name
          input.value = deliveryId;
          form.appendChild(input);
        });

        // Continue with the form submission
        form.submit();
      });
    }
  });
</script>
{% endblock %}
