{% extends 'admin/change_form.html' %} {% block extrastyle %}
<style>
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .loading-overlay .loading-spinner {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #3498db;
    border-radius: 50%;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %} {% block after_related_objects %}
<div
  style="
    display: block;
    overflow: hidden;
    padding-left: 20px;
    background-color: white;
  "
>
  <form action="/api/delivery/report" method="post">
    {% csrf_token %}
    <label for="date">Generate driver report:</label>
    <select id="date">
      {% for date in date_list %}
      <option value="{{ date }}">{{ date }}</option>
      {% endfor %}
    </select>
    <input id="user" type="hidden" name="user" value="{{ employee_id }}" />
    <input
      type="button"
      value="Get Report"
      class="submit-button"
      onclick="sendReport()"
    />
  </form>

  <form style="padding-top:20px;">
    <label for="date">Saved reports:</label><br />
    <div style="padding:25px">
      {% for pdf_path in pdf_list %}
      <a href="{{ pdf_path }}" target="_blank">{{ pdf_path }}</a><br />
      {% endfor %}
    </div>
  </form>
</div>

<div class="loading-overlay" id="loading-overlay" style="display: none">
  <div class="loading-spinner"></div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script>
  function sendReport() {
    var data = {
      date: document.getElementById("date").value,
      user: document.getElementById("user").value,
    };
    document.getElementById("loading-overlay").style.display = "flex";

    $.ajax({
      url: "/api/driver/report/",
      type: "POST",
      dataType: "json",
      contentType: "application/json",
      data: JSON.stringify(data),
      success: function (response) {
        document.getElementById("loading-overlay").style.display = "none";
        window.open(response.path, "_blank");
        window.location.reload();
      },
      error: function (xhr, status, error) {
        var errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "An error occurred.";
        document.getElementById("loading-overlay").style.display = "none";
        alert(errorMessage)
      },
    });
  }
</script>
{% endblock %}
